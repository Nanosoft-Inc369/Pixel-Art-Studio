<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pixel Art Studio (Beta) v0.1.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet" />
    <style>
        :root {
            --bg: #09090b;       /* Deepest Black */
            --panel: #18181b;    /* Sidebar Background */
            --border: #27272a;   /* Borders */
            --accent: #6366f1;   /* Primary Action Color */
            --accent-hover: #4f46e5;
            --text-main: #f4f4f5;
            --text-muted: #71717a;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none; /* Prevents text selection during drawing */
        }

        /* --- Layout --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* --- Sidebar (Left) --- */
        .sidebar {
            width: 300px;
            min-width: 300px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 24px;
            overflow-y: auto;
            z-index: 20;
        }

        .brand {
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .version-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.65rem;
            background: #27272a;
            color: var(--accent);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .section-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* --- Buttons --- */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #27272a;
            color: var(--text-main);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover { background: #3f3f46; border-color: #52525b; }
        .btn:active { transform: translateY(1px); }

        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        
        .btn-danger { color: #ef4444; border-color: rgba(239,68,68,0.2); background: rgba(239,68,68,0.05); }
        .btn-danger:hover { background: rgba(239,68,68,0.1); border-color: #ef4444; }

        .btn-icon-only { width: 100%; padding: 8px; }

        /* --- Inputs & Sliders --- */
        .slider-wrapper { margin-bottom: 8px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; }
        input[type="range"] {
            width: 100%; height: 4px; background: #3f3f46; border-radius: 2px; appearance: none; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none; width: 14px; height: 14px; background: var(--text-main); border-radius: 50%; border: 2px solid var(--panel);
        }

        select {
            width: 100%; padding: 10px; background: #09090b; border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; outline: none; cursor: pointer; font-size: 0.85rem;
        }

        /* --- Palette Grid --- */
        #paletteDisplay {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 8px;
        }
        .swatch {
            aspect-ratio: 1;
            border-radius: 2px;
            cursor: pointer;
            transition: transform 0.1s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .swatch:hover { transform: scale(1.2); z-index: 10; border-color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* --- Main Viewport (Right) --- */
        .viewport {
            flex-grow: 1;
            position: relative;
            background-color: #111;
            /* Checkerboard Pattern for Transparency */
            background-image:
                linear-gradient(45deg, #161616 25%, transparent 25%),
                linear-gradient(-45deg, #161616 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #161616 75%),
                linear-gradient(-45deg, transparent 75%, #161616 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* --- Canvas Wrapper --- */
        .canvas-container {
            position: relative;
            box-shadow: 0 0 0 1px #333, 0 20px 60px rgba(0,0,0,0.5);
        }
        canvas { display: block; image-rendering: pixelated; }
        #gridCanvas { position: absolute; top: 0; left: 0; pointer-events: none; opacity: 0; transition: opacity 0.2s; }

        /* --- Floating Toolbar --- */
        .floating-toolbar {
            position: absolute;
            top: 24px;
            background: rgba(24, 24, 27, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 50;
        }

        .tool-btn {
            width: 38px; height: 38px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .tool-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .tool-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4); }

        .divider { width: 1px; height: 24px; background: var(--border); margin: 0 4px; }

        /* Color Input Customization */
        input[type="color"] {
            -webkit-appearance: none; border: none; width: 28px; height: 28px; padding: 0; overflow: hidden; border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 0 2px var(--border);
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }

        /* --- Bottom Bar --- */
        .bottom-bar {
            margin-top: auto;
            display: flex;
            gap: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- Left Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <span>Pixel Art Studio</span>
            <span class="version-badge">BETA v0.1.1</span>
        </div>

        <!-- File Operations -->
        <div>
            <div class="section-header">Project</div>
            <div class="control-group">
                <!-- Hidden file input triggered by button -->
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    <!-- Improved Upload Icon -->
                    <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M12 3v12"></path>
                      <polyline points="8 7 12 3 16 7"></polyline>
                      <rect x="4" y="16" width="16" height="4" rx="2" ry="2"></rect>
                    </svg>
                    Import Image
                </button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="downloadImage()">
                        <!-- Improved Save Icon -->
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save PNG
                    </button>
                    <button class="btn btn-danger btn-icon-only" onclick="resetCanvas()" title="Clear Canvas">
                        <!-- Improved Clear Icon -->
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                            <path d="M10 11v6"></path>
                            <path d="M14 11v6"></path>
                            <rect x="9" y="4" width="6" height="2" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Engine Controls -->
        <div>
            <div class="section-header">Raster Engine</div>
            <div class="control-group">
                
                <div class="slider-wrapper">
                    <div class="slider-header"><span>Pixel Size</span> <span id="lblSize">8px</span></div>
                    <input type="range" id="rnSize" min="2" max="64" value="8" oninput="document.getElementById('lblSize').innerText=this.value+'px'">
                </div>

                <div class="slider-wrapper">
                    <div class="slider-header"><span>Dither Strength</span> <span id="lblDither">70%</span></div>
                    <input type="range" id="rnDither" min="0" max="100" value="70" oninput="document.getElementById('lblDither').innerText=this.value+'%'">
                </div>

                <div>
                    <div class="slider-header"><span>Color Palette</span></div>
                    <select id="selPalette">
                        <option value="DB32">DawnBringer 32 (Standard)</option>
                        <option value="ARNE32">Arne 32 (Vibrant)</option>
                        <option value="PICO8">Pico-8 (Fantasy)</option>
                        <option value="GAMEBOY">Gameboy (Classic)</option>
                        <option value="MONO">1-Bit (B&amp;W)</option>
                    </select>
                </div>

                <div id="paletteDisplay"></div>

                <button class="btn btn-primary" onclick="processImage()">
                    <!-- Improved Filter Icon -->
                    <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M4 4h16v4l-6 6v6l-4-4v-8z"></path>
                        <path d="M10 10l6-6"></path>
                    </svg>
                    Process Filter
                </button>
            </div>
        </div>

        <div class="bottom-bar">
            <button class="btn" onclick="performUndo()" title="Undo (Ctrl+Z)">
                <!-- Improved Undo Icon -->
                <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M3 7v6h6"></path>
                    <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
                </svg>
                Undo
            </button>
            <button class="btn" onclick="toggleGrid()">
                <!-- Improved Grid Icon -->
                <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="3" y1="9" x2="21" y2="9"></line>
                    <line x1="3" y1="15" x2="21" y2="15"></line>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                    <line x1="15" y1="3" x2="15" y2="21"></line>
                </svg>
                Grid
            </button>
        </div>
    </aside>

    <!-- Right Viewport -->
    <main class="viewport">
        <!-- Floating Tools -->
        <div class="floating-toolbar">
            <input type="color" id="mainColor" value="#6366f1" title="Active Color">
            <div class="divider"></div>
            
            <button class="tool-btn active" id="t-pencil" onclick="selectTool('pencil')" title="Pencil (P)" aria-label="Pencil Tool">
                <!-- Improved Pencil Icon -->
                <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 19l7-7-5-5-7 7v5h5z"></path>
                    <path d="M16 5l3 3"></path>
                </svg>
            </button>
            <button class="tool-btn" id="t-eraser" onclick="selectTool('eraser')" title="Eraser (E)" aria-label="Eraser Tool">
                <!-- Improved Eraser Icon -->
                <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <rect x="6" y="14" width="12" height="6" rx="2" ry="2"></rect>
                    <path d="M17 14l-5-5-5 5"></path>
                    <path d="M12 19v-7"></path>
                </svg>
            </button>
            <button class="tool-btn" id="t-fill" onclick="selectTool('fill')" title="Fill Bucket (G)" aria-label="Fill Bucket Tool">
                <!-- Improved Fill Bucket Icon -->
                <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M19 11l-7-7-7 7 7 7 7-7z"></path>
                    <line x1="14" y1="19" x2="22" y2="19"></line>
                </svg>
            </button>
            <button class="tool-btn" id="t-picker" onclick="selectTool('picker')" title="Eyedropper (I)" aria-label="Eyedropper Tool">
                <!-- Improved Eyedropper Icon -->
                <svg width="20" height="20" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M14 2c1.5 0 3 1.5 3 3 0 1.3-2 5-2 5l-2.5 2.5-3-3L14 2z"></path>
                    <path d="M2 22l6.5-6.5"></path>
                    <path d="M12.5 12.5L22 22"></path>
                </svg>
            </button>
        </div>

        <div class="canvas-container">
            <canvas id="mainCanvas"></canvas>
            <canvas id="gridCanvas"></canvas>
        </div>
    </main>

</div>

<script>
    /* --- CONSTANTS & PALETTES --- */
    const PALETTES = {
        DB32: ["#000000","#222034","#45283c","#663955","#8b4f67","#ac668a","#d394aa","#f8c7d8","#ffffff","#f5c6aa","#e07a67","#c24742","#843e43","#553556","#2d2334","#12111d","#1b2632","#324467","#5c798e","#86b9a8","#c8e29a","#f6ffc4","#846a48","#b8a36f","#d8b881","#ffc3a5","#ffe0bd","#ffffe0"],
        ARNE32: ["#000000","#1d2b53","#7e2553","#008751","#ab5236","#5f574f","#c2c3c7","#fff1e8","#ff004d","#ffa300","#ffec27","#00e436","#29adff","#83769c","#ff77a8","#ffccaa","#003254","#4a412a","#854c30","#306732","#6e271a","#945842","#a6674a","#bf8356","#e2c59a","#f0d4b9","#c9d1d1","#789c8a","#5f453a","#294657","#2e1c31","#191114"],
        PICO8: ["#000000","#1d2b53","#7e2553","#008751","#ab5236","#5f574f","#c2c3c7","#fff1e8","#ff004d","#ffa300","#ffec27","#00e436","#29adff","#83769c","#ff77a8","#ffccaa"],
        GAMEBOY: ["#0f380f","#306230","#8bac0f","#9bbc0f"],
        MONO: ["#000000", "#ffffff"]
    };

    /* --- APP STATE --- */
    const state = {
        tool: 'pencil',
        isDrawing: false,
        pixelSize: 8,
        showGrid: false,
        img: null,
        history: [],
        maxHistory: 20
    };

    /* --- INITIALIZATION --- */
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const gridCanvas = document.getElementById('gridCanvas');
    const gridCtx = gridCanvas.getContext('2d');

    function init() {
        // Set Default Canvas
        canvas.width = 800;
        canvas.height = 600;
        ctx.fillStyle = '#161616';
        ctx.fillRect(0, 0, 800, 600);
        
        updatePaletteUI();
        saveState();
        resizeGrid();

        // Event Listeners
        window.addEventListener('keydown', handleShortcuts);
        
        // Auto-process on palette change
        document.getElementById('selPalette').addEventListener('change', () => {
            updatePaletteUI();
            if(state.img) processImage();
        });
    }

    /* --- HISTORY SYSTEM --- */
    function saveState() {
        if (state.history.length >= state.maxHistory) state.history.shift();
        state.history.push(ctx.getImageData(0,0, canvas.width, canvas.height));
    }

    function performUndo() {
        if (state.history.length <= 1) return;
        state.history.pop();
        const prev = state.history[state.history.length - 1];
        ctx.putImageData(prev, 0, 0);
    }

    /* --- TOOL LOGIC --- */
    function selectTool(tool) {
        state.tool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`t-${tool}`).classList.add('active');
    }

    function setColor(hex) {
        document.getElementById('mainColor').value = hex;
        selectTool('pencil');
    }

    function updatePaletteUI() {
        const palName = document.getElementById('selPalette').value;
        const colors = PALETTES[palName];
        const container = document.getElementById('paletteDisplay');
        container.innerHTML = '';

        colors.forEach(hex => {
            const d = document.createElement('div');
            d.className = 'swatch';
            d.style.backgroundColor = hex;
            d.title = hex;
            d.onclick = () => setColor(hex);
            container.appendChild(d);
        });
    }

    /* --- DRAWING ENGINE --- */
    function handleInteraction(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        // Calculate raw position relative to canvas
        const rawX = (e.clientX - rect.left) * scaleX;
        const rawY = (e.clientY - rect.top) * scaleY;

        // Snap to grid
        const x = Math.floor(rawX / state.pixelSize) * state.pixelSize;
        const y = Math.floor(rawY / state.pixelSize) * state.pixelSize;

        // Eyedropper Tool
        if (state.tool === 'picker' && e.type === 'mousedown') {
            const p = ctx.getImageData(rawX, rawY, 1, 1).data;
            const hex = "#" + ((1 << 24) + (p[0] << 16) + (p[1] << 8) + p[2]).toString(16).slice(1);
            setColor(hex);
            return;
        }

        // Fill Tool
        if (state.tool === 'fill' && e.type === 'mousedown') {
            saveState();
            floodFill(x, y);
            return;
        }

        // Pencil / Eraser
        if (!state.isDrawing && e.type !== 'mousedown') return;
        if (e.type === 'mousedown') saveState();

        ctx.fillStyle = state.tool === 'eraser' ? '#161616' : document.getElementById('mainColor').value;
        ctx.fillRect(x, y, state.pixelSize, state.pixelSize);
    }

    /* --- FLOOD FILL ALGORITHM --- */
    function floodFill(startX, startY) {
        const pSize = state.pixelSize;
        // Sample the exact color at the click center
        const target = ctx.getImageData(startX + pSize/2, startY + pSize/2, 1, 1).data;
        const fillHex = document.getElementById('mainColor').value;
        const fill = hexToRgb(fillHex);

        // Avoid infinite loop if color is same
        if (target[0] === fill.r && target[1] === fill.g && target[2] === fill.b) return;

        const stack = [[startX, startY]];
        const w = canvas.width;
        const h = canvas.height;
        const targetR = target[0], targetG = target[1], targetB = target[2];
        let safety = 0;

        while(stack.length && safety < 50000) {
            safety++;
            const [cx, cy] = stack.pop();
            
            if(cx < 0 || cx >= w || cy < 0 || cy >= h) continue;

            // Check color match
            const p = ctx.getImageData(cx + pSize/2, cy + pSize/2, 1, 1).data;
            if (p[0] === targetR && p[1] === targetG && p[2] === targetB) {
                // Color it
                ctx.fillStyle = fillHex;
                ctx.fillRect(cx, cy, pSize, pSize);
                
                // Add neighbors
                stack.push([cx + pSize, cy]);
                stack.push([cx - pSize, cy]);
                stack.push([cx, cy + pSize]);
                stack.push([cx, cy - pSize]);
            }
        }
    }

    /* --- RASTER ENGINE (FILTERS) --- */
    function processImage() {
        if (!state.img) return;
        saveState();

        const pSize = parseInt(document.getElementById('rnSize').value);
        state.pixelSize = pSize;

        // Resize Canvas to fit Image Ratio
        const ratio = state.img.width / state.img.height;
        const newW = 800;
        const newH = 800 / ratio;
        canvas.width = newW;
        canvas.height = newH;
        resizeGrid();

        // 1. Draw Original Image
        ctx.drawImage(state.img, 0, 0, newW, newH);

        // 2. Prepare Data for Processing
        const imgData = ctx.getImageData(0, 0, newW, newH);
        const data = imgData.data;
        
        const palName = document.getElementById('selPalette').value;
        const palette = PALETTES[palName].map(hexToRgb);
        const ditherStrength = document.getElementById('rnDither').value / 100;

        // 3. Process Blocks
        for (let y = 0; y < newH; y += pSize) {
            for (let x = 0; x < newW; x += pSize) {
                // Sample Center of Pixel Block
                const i = ((y + Math.floor(pSize/2)) * newW + (x + Math.floor(pSize/2))) * 4;
                if (i >= data.length) continue;

                const oldC = { r: data[i], g: data[i+1], b: data[i+2] };
                const newC = findClosest(oldC, palette);

                const err = {
                    r: (oldC.r - newC.r) * ditherStrength,
                    g: (oldC.g - newC.g) * ditherStrength,
                    b: (oldC.b - newC.b) * ditherStrength
                };

                // Fill the block with new color
                for (let by = 0; by < pSize; by++) {
                    for (let bx = 0; bx < pSize; bx++) {
                        if (x+bx >= newW || y+by >= newH) continue;
                        const bi = ((y+by)*newW + (x+bx)) * 4;
                        data[bi] = newC.r;
                        data[bi+1] = newC.g;
                        data[bi+2] = newC.b;
                    }
                }

                // Floyd-Steinberg Dithering to Neighbors
                distributeError(data, newW, newH, x + pSize, y, err, 7/16, pSize);
                distributeError(data, newW, newH, x - pSize, y + pSize, err, 3/16, pSize);
                distributeError(data, newW, newH, x, y + pSize, err, 5/16, pSize);
                distributeError(data, newW, newH, x + pSize, y + pSize, err, 1/16, pSize);
            }
        }
        
        ctx.putImageData(imgData, 0, 0);
    }

    function findClosest(c, palette) {
        let min = Infinity;
        let best = palette[0];
        for (let p of palette) {
            let dist = (c.r - p.r)**2 + (c.g - p.g)**2 + (c.b - p.b)**2;
            if (dist < min) { min = dist; best = p; }
        }
        return best;
    }

    function distributeError(data, w, h, x, y, err, weight, size) {
        if (x < 0 || x >= w || y < 0 || y >= h) return;
        // Apply error to center of target block
        const i = ((y + Math.floor(size/2)) * w + (x + Math.floor(size/2))) * 4;
        data[i] = Math.min(255, Math.max(0, data[i] + err.r * weight));
        data[i+1] = Math.min(255, Math.max(0, data[i+1] + err.g * weight));
        data[i+2] = Math.min(255, Math.max(0, data[i+2] + err.b * weight));
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return {r, g, b};
    }

    /* --- FILE IO --- */
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const f = e.target.files[0];
        if(!f) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            state.img = new Image();
            state.img.onload = () => processImage();
            state.img.src = ev.target.result;
        };
        reader.readAsDataURL(f);
        e.target.value = null; // Reset
    });

    function downloadImage() {
        if(!canvas) return;
        const link = document.createElement('a');
        const timestamp = Math.floor(Date.now() / 1000);
        link.download = `pixel-art-${timestamp}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
    }

    function resetCanvas() {
        state.img = null;
        ctx.fillStyle = '#161616';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        saveState();
    }

    /* --- UTILITIES --- */
    function toggleGrid() {
        state.showGrid = !state.showGrid;
        document.getElementById('gridCanvas').style.opacity = state.showGrid ? "0.25" : "0";
        if(state.showGrid) resizeGrid();
    }

    function resizeGrid() {
        gridCanvas.width = canvas.width;
        gridCanvas.height = canvas.height;
        gridCtx.clearRect(0,0, gridCanvas.width, gridCanvas.height);
        
        if(!state.showGrid) return;
        
        gridCtx.beginPath();
        gridCtx.strokeStyle = "#ffffff";
        gridCtx.lineWidth = 1;

        const sz = state.pixelSize;
        for (let x = 0; x <= canvas.width; x += sz) {
            gridCtx.moveTo(x, 0); gridCtx.lineTo(x, canvas.height);
        }
        for (let y = 0; y <= canvas.height; y += sz) {
            gridCtx.moveTo(0, y); gridCtx.lineTo(canvas.width, y);
        }
        gridCtx.stroke();
    }

    function handleShortcuts(e) {
        if (e.key.toLowerCase() === 'z' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); performUndo(); }
        if (e.key.toLowerCase() === 'p') selectTool('pencil');
        if (e.key.toLowerCase() === 'e') selectTool('eraser');
        if (e.key.toLowerCase() === 'g') selectTool('fill');
        if (e.key.toLowerCase() === 'i') selectTool('picker');
    }

    /* --- MOUSE BINDINGS --- */
    canvas.addEventListener('mousedown', (e) => { state.isDrawing = true; handleInteraction(e); });
    canvas.addEventListener('mousemove', handleInteraction);
    canvas.addEventListener('mouseup', () => state.isDrawing = false);
    canvas.addEventListener('mouseleave', () => state.isDrawing = false);

    /* --- START --- */
    init();

</script>
</body>
</html>
